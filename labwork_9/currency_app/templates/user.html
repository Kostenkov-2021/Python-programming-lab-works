{% extends "base.html" %}

{% block title %}Пользователь {{ user.name }} - Currency Tracker{% endblock %}

{% block extra_css %}
<style>
.chart-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.subscription-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.subscription-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
}

.subscription-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.currency-code {
    font-size: 1.5em;
    font-weight: bold;
    color: #2c3e50;
}

.currency-value {
    font-size: 1.2em;
    color: #27ae60;
    font-weight: bold;
}

.subscription-info {
    margin-bottom: 15px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.info-label {
    color: #7f8c8d;
}

.info-value {
    font-weight: 500;
}

.user-profile-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.user-avatar-large {
    font-size: 4em;
    color: #3498db;
}

.user-details {
    flex-grow: 1;
}

.user-name-large {
    font-size: 2em;
    margin: 0;
    color: #2c3e50;
}

.user-id-large {
    color: #7f8c8d;
    font-size: 1.1em;
}

.user-actions {
    display: flex;
    gap: 10px;
}

.empty-subscriptions {
    text-align: center;
    padding: 40px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.empty-icon {
    font-size: 4em;
    color: #bdc3c7;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="user-profile-header">
    <div class="user-avatar-large">
        <i class="fas fa-user-circle"></i>
    </div>
    
    <div class="user-details">
        <h1 class="user-name-large">{{ user.name }}</h1>
        <p class="user-id-large">ID пользователя: {{ user.id }}</p>
        <p class="subscriptions-count">
            <i class="fas fa-bell"></i>
            Подписок: {{ user.subscriptions|length }}
        </p>
    </div>
    
    <div class="user-actions">
        <a href="/users" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Назад к списку
        </a>
        <button class="btn btn-primary" onclick="showSubscribeModal()">
            <i class="fas fa-plus"></i>
            Добавить подписку
        </button>
    </div>
</div>

{% if user.subscriptions %}
<div class="chart-container">
    <h2>Динамика курсов за 3 месяца</h2>
    <canvas id="currencyChart" width="800" height="400"></canvas>
</div>

<div class="subscriptions-section">
    <h2>Подписки пользователя</h2>
    <div class="subscription-grid">
        {% for currency in subscriptions %}
        <div class="subscription-card">
            <div class="subscription-header">
                <div>
                    <span class="currency-code">{{ currency.char_code }}</span>
                    <h4>{{ currency.name }}</h4>
                </div>
                <div class="currency-value">
                    {{ currency.value }} RUB
                </div>
            </div>
            
            <div class="subscription-info">
                <div class="info-row">
                    <span class="info-label">Цифровой код:</span>
                    <span class="info-value">{{ currency.num_code }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Номинал:</span>
                    <span class="info-value">{{ currency.nominal }} {{ currency.char_code }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Курс за 1 ед.:</span>
                    <span class="info-value">{{ "%.4f"|format(currency.value / currency.nominal) }} RUB</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Обновлено:</span>
                    <span class="info-value">{{ currency.last_updated }}</span>
                </div>
            </div>
            
            <div class="subscription-actions">
                <button class="btn btn-danger btn-block" 
                        onclick="unsubscribeFromCurrency('{{ currency.id }}')">
                    <i class="fas fa-bell-slash"></i>
                    Отписаться
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="empty-subscriptions">
    <div class="empty-icon">
        <i class="fas fa-bell-slash"></i>
    </div>
    <h3>Нет активных подписок</h3>
    <p>У этого пользователя пока нет подписок на валюты.</p>
    <button class="btn btn-primary btn-lg" onclick="showSubscribeModal()">
        <i class="fas fa-plus"></i>
        Добавить первую подписку
    </button>
</div>
{% endif %}

<!-- Модальное окно добавления подписки -->
<div id="subscribeModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Добавить подписку на валюту</h3>
            <button class="close-btn" onclick="closeSubscribeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="subscribeForm" onsubmit="return subscribeToCurrency(event)">
                <input type="hidden" id="userId" value="{{ user.id }}">
                
                <div class="form-group">
                    <label for="currencySelect">Выберите валюту:</label>
                    <select id="currencySelect" class="form-control" required>
                        <option value="">-- Выберите валюту --</option>
                        {% for currency in all_currencies %}
                        <option value="{{ currency.id }}">
                            {{ currency.char_code }} - {{ currency.name }} ({{ currency.value }} RUB)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Подписаться</button>
                    <button type="button" class="btn btn-secondary" 
                            onclick="closeSubscribeModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Данные для графика
const chartData = {{ chart_data|tojson }};

// Инициализация графика
document.addEventListener('DOMContentLoaded', function() {
    if (chartData && chartData.labels && chartData.labels.length > 0) {
        const ctx = document.getElementById('currencyChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Динамика курсов валют за 3 месяца'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toFixed(2) + ' RUB';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Дата'
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Курс (RUB)'
                        },
                        beginAtZero: false
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest'
                }
            }
        });
    }
});

function showSubscribeModal() {
    document.getElementById('subscribeModal').style.display = 'flex';
}

function closeSubscribeModal() {
    document.getElementById('subscribeModal').style.display = 'none';
}

function subscribeToCurrency(event) {
    event.preventDefault();
    
    const userId = document.getElementById('userId').value;
    const currencyId = document.getElementById('currencySelect').value;
    
    fetch(`/api/users/${userId}/subscribe`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ currency_id: currencyId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Подписка успешно добавлена');
            closeSubscribeModal();
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при добавлении подписки');
    });
}

function unsubscribeFromCurrency(currencyId) {
    const userId = {{ user.id }};
    
    if (confirm('Вы уверены, что хотите отписаться от этой валюты?')) {
        fetch(`/api/users/${userId}/unsubscribe`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ currency_id: currencyId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Вы успешно отписались от валюты');
                location.reload();
            } else {
                alert('Ошибка: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при отписке');
        });
    }
}

// Закрытие модального окна при клике вне его
window.onclick = function(event) {
    const modal = document.getElementById('subscribeModal');
    if (event.target == modal) {
        closeSubscribeModal();
    }
}
</script>
{% endblock %}